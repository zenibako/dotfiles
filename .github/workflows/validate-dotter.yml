name: Validate Dotter Deployment

on:
  push:
    branches: ["main", "master"]
  pull_request:
    branches: ["main", "master"]
  workflow_dispatch:

jobs:
  validate-dotter:
    name: Validate ${{ matrix.profile }}/${{ matrix.theme }} on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]
        profile: [default, personal, work]
        theme: [monokai, nightowl, tokyonight]
        exclude:
          # Exclude default+monokai from base matrix for platform-specific testing
          - os: ubuntu-latest
            profile: default
            theme: monokai
          - os: macos-latest
            profile: default
            theme: monokai
        include:
          # Test linux package on Ubuntu with default+monokai
          - os: ubuntu-latest
            profile: default
            theme: monokai
            extra_packages: linux
          # Test mac package on macOS with default+monokai
          - os: macos-latest
            profile: default
            theme: monokai
            extra_packages: mac
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install dotter
        run: |
          case "$RUNNER_OS" in
            Linux)
              wget https://github.com/SuperCuber/dotter/releases/latest/download/dotter-linux-x64-musl -O dotter
              chmod +x dotter
              sudo mv dotter /usr/local/bin/
              ;;
            macOS)
              brew install dotter
              ;;
          esac

      - name: Verify dotter installation
        run: dotter --version

      - name: Create temporary deployment directory
        run: |
          DEPLOY_DIR=$(mktemp -d)
          echo "DEPLOY_DIR=$DEPLOY_DIR" >> $GITHUB_ENV
          echo "Created deployment directory: $DEPLOY_DIR"

      - name: Test dotter deployment
        run: |
          echo "Testing deployment for profile: ${{ matrix.profile }}, theme: ${{ matrix.theme }}"
          
          # Determine platform package based on OS
          case "$RUNNER_OS" in
            Linux)
              PLATFORM_PKG="linux"
              ;;
            macOS)
              PLATFORM_PKG="mac"
              ;;
          esac
          
          # Build package list for this combination
          PACKAGES=("${{ matrix.profile }}" "$PLATFORM_PKG" "${{ matrix.theme }}")
          if [ -n "${{ matrix.extra_packages }}" ]; then
            PACKAGES+=("${{ matrix.extra_packages }}")
          fi
          
          echo "Package combination: ${PACKAGES[@]}"
          
          # Create a local.toml for this test with profile-specific variable overrides
          cat > .dotter/local.toml <<'EOF'
          packages = [
          EOF
          
          for pkg in "${PACKAGES[@]}"; do
            echo "  \"$pkg\"," >> .dotter/local.toml
          done
          
          cat >> .dotter/local.toml <<'EOF'
          ]

          [variables]
          # Test variable overrides based on profile
          EOF
          
          # Add profile-specific variables to test templating
          case "${{ matrix.profile }}" in
            work)
              cat >> .dotter/local.toml <<'EOF'
          email = "test@work.example.com"
          username = "test.user"
          apex_lsp_jar_path = "/test/path/apex-jorje-lsp.jar"
          gitlab_personal_access_token = "glpat-test123456789"
          gitlab_api_url = "https://gitlab.example.com/api/v4"
          lsp_salesforce_disabled = false
          mcp_atlassian_enabled = true
          mcp_gitlab_enabled = true
          opencode_build_agent_model = "github-copilot/claude-sonnet-4.5"
          opencode_plan_agent_model = "github-copilot/claude-opus-4.5"
          EOF
              ;;
            personal)
              cat >> .dotter/local.toml <<'EOF'
          email = "test@personal.example.com"
          github_personal_access_token = "ghp_test123456789"
          home_assistant_url = "https://test.hass.example.com"
          home_assistant_token = "test_token_123"
          playdate_sdk_enabled = true
          mcp_backlog_enabled = true
          EOF
              ;;
            default)
              cat >> .dotter/local.toml <<'EOF'
          email = "test@default.example.com"
          github_personal_access_token = "ghp_test123456789"
          EOF
              ;;
          esac
          
          echo "Generated local.toml:"
          cat .dotter/local.toml
          
          # Perform deployment to the temporary directory by overriding HOME
          # The --force flag allows overwriting files from the depends chain
          HOME="$DEPLOY_DIR" dotter deploy --force --verbose

      - name: Verify deployment
        run: |
          echo "Verifying files were deployed to $DEPLOY_DIR"
          ls -la "$DEPLOY_DIR" || true
          find "$DEPLOY_DIR" -type f | head -20 || true

      - name: Cleanup
        if: always()
        run: |
          if [ -n "$DEPLOY_DIR" ] && [ -d "$DEPLOY_DIR" ]; then
            rm -rf "$DEPLOY_DIR"
            echo "Cleaned up deployment directory"
          fi

  validate-syntax:
    name: Validate Configuration Syntax
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install TOML validator
        run: |
          pip install toml

      - name: Validate TOML files
        run: |
          python3 << 'EOF'
          import toml
          import sys
          from pathlib import Path
          
          files = [
              '.dotter/global.toml',
              'atuin/config.toml',
              'iamb/config.toml',
              'jj/config.toml',
          ]
          
          failed = False
          for file in files:
              try:
                  with open(file, 'r') as f:
                      toml.load(f)
                  print(f"✓ {file} is valid TOML")
              except Exception as e:
                  print(f"✗ {file} failed: {e}")
                  failed = True
          
          sys.exit(1 if failed else 0)
          EOF

      - name: Install dotter
        run: |
          wget https://github.com/SuperCuber/dotter/releases/latest/download/dotter-linux-x64-musl -O dotter
          chmod +x dotter
          sudo mv dotter /usr/local/bin/

      - name: Test global.toml for duplicate variables
        run: |
          echo "Testing each profile without variable overrides to catch conflicts in global.toml"
          
          for profile in default personal work; do
            echo "Testing $profile profile..."
            cat > .dotter/local.toml <<EOF
          packages = ["$profile", "linux", "monokai"]
          EOF
            
            if ! dotter deploy --dry-run --force 2>&1 | tee /tmp/dotter-$profile.log; then
              echo "✗ Failed to deploy $profile profile"
              cat /tmp/dotter-$profile.log
              exit 1
            fi
            echo "✓ $profile profile deploys successfully"
          done

      - name: Deploy with dotter (for Lua validation)
        run: |
          # Create local.toml for default + linux + monokai packages
          cat > .dotter/local.toml <<'EOF'
          packages = ["default", "linux", "monokai"]
          EOF
          
          echo "Deploying configs for validation"
          dotter deploy --force --verbose

      - name: Validate Lua files
        run: |
          # Install luac for syntax checking
          sudo apt-get update
          sudo apt-get install -y lua5.4
          
          # Check deployed Lua files (after dotter processing)
          if [ -d "$HOME/.config/nvim" ]; then
            find "$HOME/.config/nvim" -name "*.lua" -type f | while read -r file; do
              if ! luac -p "$file" > /dev/null 2>&1; then
                echo "✗ Syntax error in $file"
                luac -p "$file"
                exit 1
              else
                echo "✓ $file is valid Lua"
              fi
            done
          else
            echo "⚠ No nvim config found in $HOME/.config/nvim, skipping Lua validation"
          fi
